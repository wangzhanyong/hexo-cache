const cacheList = <%- cacheList %>
const cacheKey = 'hexo-cache-v<%=version%>'
<% if (ignoreRequestKeywords) { %>
const ignoreRequestKeywords = <%- ignoreRequestKeywords %>
<% } %>
const matchOptions = {
  ignoreSearch: true,
  ignoreMethod: true,
  ignoreVary: true
}
self.addEventListener('install', function (event) {
  event.waitUntil(
    caches.open(cacheKey)
      .then(function (cache) {
        return cache.addAll(cacheList)
      })
      .then(() => {
        self.skipWaiting()
      })
  )
})

self.addEventListener('activate', function (event) {
  event.waitUntil(
    caches.keys().then(function (keys) {
      Promise.all(keys.map(function (key) {
        if (key !== cacheKey) {
          return caches.delete(key)
        }
      }))
        .then(() => {
          self.clients.claim()
        })
    })
  )
})

const isIgnore = (request) => {
  if (request.method !== 'GET') return true
  ignoreRequestKeywords.some(keyword => {
    if (request.url.includes(keyword)) return true
  })
  return false
}

self.addEventListener('fetch', function (event) {
  if (isIgnore(event.request)) return fetch(event.request)
  event.respondWith(
    caches.match(event.request, matchOptions)
      .then(function (response) {
        if (response) {
          return response
        }
        throw Error('go catch')
      })
      .catch(()=> {
        var requestClone = event.request.clone() // 把原始请求拷过来
        return fetch(requestClone).then(function (httpRes) {
          if (httpRes.status !== 200) {
            return httpRes
          }
          var responseClone = httpRes.clone()
          caches.open(cacheKey).then(function (cache) {
            cache.put(event.request, responseClone)
          })
          return httpRes
        })
      })
  )
})
